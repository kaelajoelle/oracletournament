<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Oracle Trials — Character Builder</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <style>
  :root{
    --bg:#f8f2df; --panel:#f5eed5; --ink:#3b2b1a; --muted:#6e5a3e;
    --accent:#b38b46; --border:#c8b27a;
  }

  body{
    margin:0;
    font-family:'Open Sans',sans-serif;
    background:var(--bg) url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxMSEhUTExMWFhUXGR4bGBgYHRsdHx8eHyAdHh8aHh8fHSggGBolHR8fITEhJSkrLi4uHR8zODMsNygtLisBCgoKDg0OGxAQGy0lICYrLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAKMBNgMBIgACEQEDEQH/xAAcAAEAAgMBAQEAAAAAAAAAAAAABgcEBQIDCAP/xABBEAABAwICBgQDBgUDAgcAAAABAAIRAyEEEjEFQVEGEyJhcYEykaGxFCNCUrHB0fAVM1Ji8SQzQ2KC0vE0gpL/xAAZAQEAAwEBAAAAAAAAAAAAAAAAAQMEAgX/xAArEQEBAAIBAwMDBQEAAAAAAAAAAQIRAyExBBJBURMiYXGB8BRRgaHB/9oADAMBAAIRAxEAPwDjKj0ZyVwzgsce3f5Xj0Rz1qKwXfRrEpjSQhDCnKtISX0reFUZRlfKk9hz6eXWhSTSw1K4tTGCmWiMtgRCRSl6H6i4m6lGu9YxkXc6IuzAblYbmAIET8jAzWv6hV9zC7n5ykhZJdkNLE7wEQN2HB9y9Kt00G02JmWGlWRBBGCBuVU9yVBOVSSOCcnHsTQb6V5JNWkcK3Lo+Q4a+qMtY1OjgRql8UVK6C+9oCCGyY6IB+leU+XSGHbRfscR0/djj3GJrb7oF0zV1bWylpE2ptxDkNEcDqD9P6VVrHCe03mjqaiLWWsF13rM4yDhjby4KeQfuVdPwKcWo7qXtNe5LNm0lQysoKqp1OcL1KXn86euqdRcuVWJ7hIfEWG4yFbSKpXPBVX52Ukfc0fVxD5cz6V8pVkgAVACqB5B2AGcfI/wA9KyjRGRq8Gxmv8AjOox2taeT8M1ieo9zO+nEmo4r0e7SDuLohgqUUDKSVx3qe0g7vM7XTSM9SctIibBbqOaHTfU5AIVQ5qFqE48bUw6SvfTZLP1G55jbdMDxvl0ZBGp81TVRtWs1CC4uLjHE2y0olB9ozvbxO+v1qzfjVtxhIplpbp4cfX6HNEqkcjaFhiBFiWIEViVjx5fU8T0rbxXEanFdrCeXAUv40cH0I9/SvNrVfX9vE8P8A8bX2FbV1c+5H/9k=') repeat;
    color:var(--ink);
    line-height:1.6;
    background-size:cover;
    background-attachment:fixed;
  }

  header{
    text-align:center;
    padding:2rem 1rem 1rem;
    border-bottom:2px solid var(--border);
    background:rgba(248,242,223,.9);
    font-family:'IM Fell English SC',serif;
  }

  h1{ font-size:2.2rem; margin:.2rem 0 .3rem; color:var(--ink); }
  .subtitle{ color:var(--muted); font-size:1rem; font-style:italic; }

  .disclaimer{
    max-width:900px; margin:1rem auto; background:var(--panel);
    border:2px solid var(--border); border-radius:12px; padding:1rem 1.5rem;
    box-shadow:0 2px 8px rgba(0,0,0,.08); color:var(--muted); font-style:italic; position:relative;
  }
  .disclaimer::before{ content:"✶"; position:absolute; top:-10px; left:12px; color:var(--accent); }

  .wizard{ display:grid; grid-template-columns:280px 1fr; gap:20px; max-width:1200px; margin:0 auto; padding:1.5rem; }

  .nav{
    background:var(--panel);
    border:2px solid var(--border);
    border-radius:12px;
    padding:1rem;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
  } 

  .grid{ display:grid; gap:12px; }
  .grid.cols-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
  .panel,.card{
    background:var(--panel); border:2px solid var(--border); border-radius:12px; padding:12px;
  }
  .kicker{ font-size:.9rem; color:var(--muted); }
  .muted{ color:var(--muted); }
  .flex{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .pill{ display:inline-flex; gap:8px; align-items:center; border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:#efe7c8; }
  .controls{ display:flex; justify-content:space-between; margin-top:12px; }
  button{ padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:#efe7c8; cursor:pointer; }
  .primary{ background:#d9c38b; }
  .danger{ background:#e7b0a9; }
  .stepbtn{ width:100%; text-align:left; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#efe7c8; }
  .stepbtn.active{ outline:2px solid rgba(179,139,70,.35); }
  .table{ width:100%; border-collapse:collapse; }
  .table th,.table td{ border-bottom:1px solid var(--border); padding:8px 6px; text-align:left; }
  
  /* =============== MOBILE PATCH =============== */
  @media (max-width: 900px){
    body{
      background-attachment: scroll;
      background-size: 120% auto;
    }
    header{ padding: 1rem .75rem .75rem; }
    h1{ font-size: 1.6rem; }
    .subtitle{ font-size: .95rem; }
    .wizard{ grid-template-columns: 1fr; gap: 12px; padding: .75rem; }
    .nav{ padding: .75rem; }
    .nav .stepbtn{ padding: 10px; font-size: .95rem; }

    #stepNav{
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }

    button{ padding: 12px 14px; min-height: 44px; width: 100%; }
    .controls{ flex-direction: column; gap: 8px; }
    .controls .left, .controls .right{ width: 100%; gap: 8px; }
    .controls .right button{ width: 100%; }

    .panel, .card{ padding: 12px; border-radius: 10px; }
    input, select, textarea{ font-size: 16px; }
    .grid.cols-2{ grid-template-columns: 1fr; }
    .two{ grid-template-columns: 1fr; }
    .pill{ padding: 6px 10px; }

    .table{ width: max(640px, 100%); }
    .table-wrap{
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }
    .table-wrap::after{
      content:""; position:absolute; top:0; right:0; width:24px; height:100%;
      pointer-events:none; background: linear-gradient(to left, rgba(0,0,0,.06), transparent);
    }
    .kicker{ font-size: .85rem; }
    .muted{ font-size: .9rem; }
  }

  .table-wrap{ overflow: visible; } /* desktop default */

  /* =============== FORM & TABLE SPACING TUNE-UP =============== */
  label { display: block; font-weight: 600; margin-bottom: 4px; color: var(--ink); }
  input, select, textarea {
    width: 100%; padding: 6px 8px; border: 1px solid var(--border);
    border-radius: 6px; background: #fcf8e8; box-sizing: border-box;
  }
  #ability_box .card { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; margin-bottom: 6px; }
  #ability_box select, #ability_box input[type="number"] { width: 70px; text-align: center; }
  .grid.cols-2 > div { display: flex; flex-direction: column; gap: 4px; }
  .panel { padding: 1.2rem; border-radius: 12px; border: 2px solid var(--border); background: var(--panel); margin-bottom: 12px; }
  .controls { margin-top: 16px; }
  .controls .right { display: flex; justify-content: flex-end; gap: 8px; }
  .table th, .table td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
  .table th { background: rgba(179,139,70,0.1); font-weight: 600; text-align: center; }
  .table td { text-align: center; }

  .nav { padding: 14px; }
  #stepNav { display: flex; flex-direction: column; gap: 10px; }
  .stepbtn{ padding: 12px 14px; border-radius: 10px; line-height: 1.1; font-weight: 600; box-shadow: 0 1px 0 rgba(0,0,0,.06) inset; }
  .stepbtn.active{ outline: 2px solid rgba(179,139,70,.35); background: linear-gradient(180deg, #fff8df, #f4e8bf); }

  .nav .callout { margin-top: 14px; }
  .nav .callout .flex { gap: 8px; flex-wrap: wrap; }
  button[disabled]{ opacity:.55; cursor:not-allowed; filter:grayscale(.2); }

  .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .card { overflow: hidden; }

  .table.avail { min-width: 760px; border-collapse: separate; border-spacing: 0; }
  .table.avail th, .table.avail td { border-bottom: 1px solid var(--border); padding: 6px 8px; white-space: nowrap; }
  .table.avail th:first-child, .table.avail td:first-child { width: 160px; }

  .two { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
  .callout { background: #fff8df; border: 2px solid var(--border); border-radius: 10px; padding: 10px 12px; }

  .avail-card { padding: 0; border-radius: 12px; overflow: hidden; }
  .table-scroll { position: relative; background: var(--panel); padding: 8px; }
  .table-scroll::after{ content:""; position:absolute; top:0; right:0; width:24px; height:100%; pointer-events:none; background: linear-gradient(to left, rgba(0,0,0,.06), transparent); }

  .table.avail thead th {
    position: sticky; top: 0; z-index: 2; background: rgba(179,139,70,0.12); backdrop-filter: blur(2px);
  }
  .table.avail th:first-child, .table.avail td:first-child {
    position: sticky; left: 0; z-index: 1; background: var(--panel); text-align: left; font-weight: 600;
  }

  #stepNav { gap: 12px; }
  .stepbtn { padding: 12px 16px; }

  /* --- Arcane accordion --- */
  details.scroll-letter {
    border: 2px solid var(--border); border-radius: 12px; background: rgba(245,238,213,0.95);
    box-shadow: 0 2px 8px rgba(0,0,0,.06); overflow: hidden;
  }
  details.scroll-letter > summary {
    list-style: none; cursor: pointer; padding: 0.9rem 1.1rem;
    font-family: 'IM Fell English SC', serif; font-size: 1.15rem;
    display: flex; align-items: center; gap: .6rem;
    background: linear-gradient(180deg, #fff8df, #f4e8bf); border-bottom: 1px solid var(--border); user-select: none;
  }
  details.scroll-letter > summary::-webkit-details-marker { display: none; }
  details.scroll-letter > summary .chev { margin-left: auto; transition: transform .2s ease; }
  details.scroll-letter[open] > summary .chev { transform: rotate(90deg); }
  .seal { display:inline-flex; align-items:center; justify-content:center; width: 26px; height: 26px; border-radius: 50%; background: #b38b46; color: #f7f2dd; font-weight: 700; box-shadow: inset 0 -2px 0 rgba(0,0,0,.15); font-family: 'IM Fell English SC', serif; }
  .scroll-content { padding: 1.1rem 1.25rem 1.25rem; font-family: 'IM Fell English SC', serif; line-height: 1.6; }

  .scroll-content .table th { text-align:center; }
  .scroll-content .table { margin: .8rem 0; }

  .college-table table { width:100%; border-collapse: collapse; table-layout: fixed; }
  .college-table th, .college-table td { padding: 10px; border-bottom: 1px solid var(--border); }
  .college-table th { background: rgba(179,139,70,0.12); }

  .college-accordion details {
    border: 2px solid var(--border); border-radius: 12px; background: var(--panel); margin: 8px 0; overflow: hidden;
  }
  .college-accordion summary {
    cursor: pointer; list-style: none; padding: 12px 14px; font-weight: 700; display: flex; align-items: center; justify-content: space-between;
  }
  .college-accordion summary::after {
    content: "▸"; transform: rotate(0deg); transition: transform .15s ease; color: var(--muted); margin-left: 10px; font-weight: 400;
  }
  .college-accordion details[open] summary::after { transform: rotate(90deg); }
  .college-accordion .panel { border: 0; border-top: 1px solid var(--border); border-radius: 0; margin: 0; padding: 12px 14px; }
  .college-accordion .kicker { color: var(--muted); margin-top: 6px; }

  /* Swap: table on desktop, accordion on mobile */
  @media (max-width: 680px){
    .intro-college-table { display:none !important; }
    .colleges-accordion{ display:block; }
    .acc-item{
      border:2px solid var(--border); border-radius:12px; background:var(--panel);
      margin:10px 0; overflow:hidden;
    }
    .acc-item summary{
      list-style:none; cursor:pointer; padding:12px 14px;
      font-family: "IM Fell English SC", serif; font-size:1.1rem;
      display:flex; justify-content:space-between; align-items:center;
    }
    .acc-item summary::-webkit-details-marker{ display:none; }
    .acc-item .acc-body{ padding:0 14px 12px; }
    .acc-kicker{ color:var(--muted); font-size:.95rem; margin:8px 0 4px; }
  }
  </style>
</head>
  
<body>
  <!-- Header + Disclaimer Section -->
  <header>
    <h1>Oracle Trials — Character Builder</h1>
    <div class="subtitle">Create your student adventurer for the winter one-shot competition.</div>
  </header>

  <div class="disclaimer">
    <strong>Disclaimer:</strong> A degree from the Oracle Academy does not guarantee immunity from fireballs, charm effects, or divine smiting. The faculty assumes no responsibility for polymorph accidents, summoned imps, or unforeseen time loops. Snacks are encouraged, hubris is not.
  </div>

  <main id="app-root">
    <div class="wizard">
      <nav class="nav">
        <h3>Steps <small id="cfgBadge" class="muted"></small></h3>
        <div id="stepNav"></div>

        <div class="card" style="margin-top:12px">
          <div class="kicker">Quick actions</div>
          <div class="flex" style="margin-top:6px">
            <button id="btnSave">Save Draft</button>
            <button id="btnLoad">Load Draft</button>
            <button id="btnExport" class="primary">Export JSON</button>
            <button id="btnClear" class="danger">Clear Local Data</button>
          </div>
        </div>
      </nav>

      <!-- JS renders each screen here -->
      <section id="panels" class="grid" style="gap:16px"></section>
    </div>
  </main>

<script>
/* =======================
   CONSTANTS & STORES
======================= */
const AVAIL_DATES = [
  '2025-12-21','2025-12-22','2025-12-23',
  '2025-12-26','2025-12-27','2025-12-28','2025-12-29',
  '2026-01-01'
];

const AvailabilityStore = {
  key: 'oracleAvailability',
  read(){ try{return JSON.parse(localStorage.getItem(this.key)||'{}');}catch{ return {}; } },
  write(obj){ localStorage.setItem(this.key, JSON.stringify(obj)); }
};

function labelDate(iso){
  try{
    const dt = new Date(iso + 'T00:00:00');
    return dt.toLocaleDateString('en-CA',{month:'short', day:'2-digit'});
  }catch{ return iso; }
}

function toLocalICS(dt){
  const pad = n => String(n).padStart(2,'0');
  return dt.getFullYear()+pad(dt.getMonth()+1)+pad(dt.getDate())+'T'+pad(dt.getHours())+pad(dt.getMinutes())+pad(dt.getSeconds());
}

function downloadICS(session){
  const tz = 'America/Edmonton';
  const start = new Date(session.date + 'T19:00:00');
  const end   = new Date(session.date + 'T21:00:00');
  const uid = `${session.id}@oracletrials`;
  const ics = [
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//OracleTrials//Scheduler//EN','CALSCALE:GREGORIAN','METHOD:PUBLISH','BEGIN:VEVENT',
    `UID:${uid}`,
    `SUMMARY:${session.title}`,
    `DESCRIPTION:DM: ${session.dm} | Capacity: ${session.capacity}`,
    `DTSTART;TZID=${tz}:${toLocalICS(start)}`,
    `DTEND;TZID=${tz}:${toLocalICS(end)}`,
    'END:VEVENT','END:VCALENDAR'
  ].join('\r\n');
  const blob = new Blob([ics], {type:'text/calendar'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${session.title.replace(/\s+/g,'-')}.ics`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* =======================
   DATA
======================= */
const DATA = {
  levels:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],
  abilityArrays:{ standard:[15,14,13,12,10,8] },
  universities:[
    { key:'lorehold', name:'Lorehold', theme:'History & Spirits', colours:'Red/White', focus:'Archaeomancy', playstyle:'Scholar / Explorer', spells:{
        1:['Comprehend Languages','Identify'],
        2:['Borrowed Knowledge','Locate Object'],
        3:['Speak with Dead','Spirit Guardians'],
        4:['Arcane Eye','Stone Shape'],
        5:['Flame Strike','Legend Lore']
    }},
    { key:'prismari', name:'Prismari', theme:'Elemental Arts', colours:'Blue/Red', focus:'Performance & Elements', playstyle:'Passion / Spectacle', spells:{
        1:['Chromatic Orb','Thunderwave'],
        2:['Flaming Sphere','Kinetic Jaunt'],
        3:['Haste','Water Walk'],
        4:['Freedom of Movement','Wall of Fire'],
        5:['Cone of Cold','Conjure Elemental']
    }},
    { key:'quandrix', name:'Quandrix', theme:'Math & Nature', colours:'Blue/Green', focus:'Fractals / Growth', playstyle:'Logical / Curious', spells:{
        1:['Entangle','Guiding Bolt'],
        2:['Enlarge/Reduce','Vortex Warp'],
        3:['Aura of Vitality','Haste'],
        4:['Control Water','Freedom of Movement'],
        5:['Circle of Power','Passwall']
    }},
    { key:'silverquill', name:'Silverquill', theme:'Eloquence & Ink', colours:'White/Black', focus:'Radiance & Shadow', playstyle:'Charisma / Wit', spells:{
        1:['Dissonant Whispers','Silvery Barbs'],
        2:['Calm Emotions','Darkness'],
        3:['Beacon of Hope','Daylight'],
        4:['Compulsion','Confusion'],
        5:['Dominate Person','Rary’s Telepathic Bond']
    }},
    { key:'witherbloom', name:'Witherbloom', theme:'Life & Decay', colours:'Green/Black', focus:'Alchemy / Essence', playstyle:'Healer / Witch', spells:{
        1:['Cure Wounds','Inflict Wounds'],
        2:['Lesser Restoration','Wither and Bloom'],
        3:['Revivify','Vampiric Touch'],
        4:['Blight','Death Ward'],
        5:['Antilife Shell','Greater Restoration']
    }}
  ],
  roster:[
    {name:'Amy', status:'Yes'},
    {name:'Aramis', status:'Unknown'},
    {name:'Becca', status:'Preferred', notes:'27, 28'},
    {name:'Bela', status:'Unknown'},
    {name:'David', status:'Unknown'},
    {name:'Emory', status:'Maybe'},
    {name:'Erin', status:'Yes', notes:'Schedule Dependant'},
    {name:'Erin Warner', status:'Preferred', notes:'26/27'},
    {name:'Evan', status:'Preferred', notes:'27, 28'},
    {name:'James', status:'Unknown'},
    {name:'Jocelyn', status:'Maybe'},
    {name:'Jordan', status:'Unknown'},
    {name:'Lazarus', status:'KidsTable', notes:'extra kids table prior to other games'},
    {name:'Link', status:'No'},
    {name:'Lyric', status:'Unknown'},
    {name:'Marvin', status:'Unknown'},
    {name:'Megan', status:'Maybe'},
    {name:'Megan E.', status:'Unknown'},
    {name:'Melissa', status:'Yes', notes:'Cannot do Dec 28'},
    {name:'Mike', status:'Maybe'},
    {name:'Nicole', status:'Yes', notes:'26-27'},
    {name:'Nova', status:'Yes', notes:'Checking Schedule'},
    {name:'Spencer', status:'Yes', notes:'26-27'},
    {name:'Trevor', status:'Preferred', notes:'22, 27, and 28/29 of December'}
  ],
  sessions:[
    {id:'s1', date:'2025-12-21', title:'Session 01', dm:'Kaela & Tory', capacity:6, players:[]},
    {id:'s2', date:'2025-12-22', title:'Session 02', dm:'Kaela & Tory', capacity:6, players:[]},
    {id:'s3', date:'2025-12-26', title:'Session 03', dm:'Kaela & Tory', capacity:6, players:[]},
    {id:'s4', date:'2025-12-27', title:'Session 04', dm:'Kaela & Tory', capacity:6, players:[]},
    {id:'s5', date:'2025-12-28', title:'Session 05', dm:'Kaela & Tory', capacity:6, players:[]},
    {id:'s6', date:'2025-12-29', title:'Session 06', dm:'Kaela & Tory', capacity:6, players:[]},
    {id:'finale', date:'2026-01-01', title:'Grand Finale', dm:'Kaela & Tory', capacity:8, players:[], finale:true}
  ]
};

/* =======================
   VALIDATION & ERROR HANDLING
======================= */
function validateConfig(){
  const errors=[];
  try{
    if(!Array.isArray(AVAIL_DATES)) errors.push('AVAIL_DATES is missing or not an array.');
    else AVAIL_DATES.forEach((d,i)=>{ if(!/^\d{4}-\d{2}-\d{2}$/.test(String(d))) errors.push(`AVAIL_DATES[${i}] must be YYYY-MM-DD (got "${d}")`); });
  }catch{ errors.push('AVAIL_DATES could not be read.'); }

  try{
    if(!Array.isArray(DATA.sessions)) errors.push('DATA.sessions is missing or not an array.');
    else{
      const ids=new Set();
      DATA.sessions.forEach((s,idx)=>{
        if(!s || typeof s!=='object'){ errors.push(`sessions[${idx}] is not an object`); return; }
        if(!s.id) errors.push(`sessions[${idx}] is missing an id`);
        if(s.id){ if(ids.has(s.id)) errors.push(`Duplicate session id: ${s.id}`); else ids.add(s.id); }
        if(!/^\d{4}-\d{2}-\d{2}$/.test(String(s.date||''))) errors.push(`${s.title||s.id||('session#'+idx)} has non-ISO date "${s.date}"`);
        if(typeof s.capacity !== 'number') errors.push(`${s.title||s.id||('session#'+idx)} capacity must be a number`);
      });
    }
  }catch{ errors.push('DATA.sessions could not be validated.'); }

  try{ if(!Array.isArray(DATA.roster)) errors.push('DATA.roster is missing or not an array.'); }
  catch{ errors.push('DATA.roster could not be validated.'); }

  return errors;
}

function showErrors(errors){
  if(!errors || !errors.length) return;
  const main=document.querySelector('main');
  const box=document.createElement('div');
  box.className='panel';
  box.style.border='1px solid #f14a3b';
  box.style.background='#1d1111';
  box.innerHTML = `
    <h2>Configuration issues</h2>
    <p>Fix the items below, then refresh. If you changed dates/IDs recently, hit <strong>Clear Local Data</strong> in the sidebar.</p>
    <ul>${errors.map(e=>`<li>${e.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</li>`).join('')}</ul>
  `;
  main.prepend(box);
}

window.addEventListener('error', (e)=>{
  const main=document.querySelector('main');
  if(!main) return;
  const box=document.createElement('div');
  box.className='panel';
  box.style.border='1px solid #f14a3b';
  box.style.background='#1d1111';
  box.innerHTML=`<strong>Runtime error:</strong> ${String(e.message||'Unknown error')}`;
  main.prepend(box);
});

/* =======================
   STATE
======================= */
const State = {
  data:{
    meta:{version:'0.5-stable'},
    core:{ name:'', race:'', class:'', background:'', level:3, abilityMethod:'standard', abilities:{STR:15,DEX:14,CON:13,INT:12,WIS:10,CHA:8}, equipment:'class'},
    university:{ key:'', spellAbility:'INT' },
    feats:[],
    extras:{ job:null, clubs:[], studentDice:[] },
    personality:{ traits:'', ideal:'', bond:'', rival:'', goal:'', prompt:'' },
    exams:{ notes:'', studyRerolls:0, results:[] }
  },
  sessions: (function(){
    const saved = JSON.parse(localStorage.getItem('oracleSessions')||'null');
    if(saved) return saved;
    return DATA.sessions.map(x=>({...x}));
  })(),
  save(){ localStorage.setItem('oracleTrialsSave', JSON.stringify(this.data)); alert('Draft saved to your browser.'); },
  load(){ const raw=localStorage.getItem('oracleTrialsSave'); if(!raw){alert('No save found.');return;} this.data=JSON.parse(raw); renderAll(); alert('Draft loaded.'); },
  export(){ const blob=new Blob([JSON.stringify({character:this.data, sessions:this.sessions},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`oracle-trials-${(this.data.core.name||'character').toLowerCase().replace(/[^a-z0-9-]/g,'-')}.json`; a.click(); URL.revokeObjectURL(url); },
  saveSessions(){ localStorage.setItem('oracleSessions', JSON.stringify(this.sessions)); }
};

/* =======================
   CSV EXPORT
======================= */
function downloadAvailabilityCSV() {
  const avail = AvailabilityStore.read();
  const dates = AVAIL_DATES.slice();
  const header = ["name", ...dates.map(labelDate)];
  const rows = [header];
  DATA.roster.forEach(r => {
    const line = [r.name];
    dates.forEach(d => { line.push(avail[r.name]?.[d] ? "Y" : ""); });
    rows.push(line);
  });
  const csv = rows.map(r => r.map(x => `"${String(x ?? "").replaceAll('"','""')}"`).join(",")).join('\n');
  const stamp = new Date().toISOString().slice(0,10).replace(/-/g,"");
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `oracle-availability-${stamp}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* =======================
   BOOT
======================= */
function renderAll(){
  try{
    renderNav();
    renderPanels();
    bindHeaderActions();
  } catch(err){
    showErrors([`Render failed: ${String(err && err.message || err)}`]);
    console.error(err);
  }
}

function bindHeaderActions(){
  const s = document.getElementById('btnSave'); if(s) s.onclick=()=>State.save();
  const l = document.getElementById('btnLoad'); if(l) l.onclick=()=>State.load();
  const e = document.getElementById('btnExport'); if(e) e.onclick=()=>State.export();
  const clr=document.getElementById('btnClear');
  if(clr){ clr.onclick=()=>{
    if(confirm('Clear all local data for this app?')){
      localStorage.removeItem('oracleSessions');
      localStorage.removeItem('oracleAvailability');
      localStorage.removeItem('oracleBuildCards');
      localStorage.removeItem('oracleTrialsSave');
      alert('Local data cleared. Reloading…');
      location.reload();
    }
  }}
}

(function(){
  const errs = validateConfig();
  if(errs.length){ showErrors(errs); bindHeaderActions(); return; }
  renderAll();
})();
</script>
      
</body>
</html>