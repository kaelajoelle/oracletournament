<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Oracle Trials — Character Builder</title>
  <style>
    :root{
      --bg:#0f0f14; --panel:#181a22; --ink:#e9ecf1; --muted:#aeb4c0;
      --accent:#e6b800; --ok:#39d98a; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(15,15,20,.9),rgba(15,15,20,.6));backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid #2a2e3a}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    h1{margin:0;font-weight:800;letter-spacing:.3px}
    .subtitle{color:var(--muted);font-size:.95rem}
    main{max-width:1100px;margin:0 auto;padding:24px}
    .wizard{display:grid;grid-template-columns:280px 1fr;gap:20px}
    .nav{background:var(--panel);border:1px solid #2a2e3a;border-radius:16px;padding:14px}
    .nav h3{margin:.2rem 0 8px 0;font-size:.95rem;color:var(--muted);font-weight:600}
    .steps{display:flex;flex-direction:column;gap:8px}
    .stepbtn{appearance:none;border:1px solid #2a2e3a;background:#141722;color:var(--ink);padding:10px 12px;border-radius:12px;text-align:left;cursor:pointer}
    .stepbtn.active{border-color:var(--accent);outline:2px solid rgba(230,184,0,.25)}
    .panel{background:var(--panel);border:1px solid #2a2e3a;border-radius:16px;padding:16px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    label{font-size:.9rem;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2e3a;background:#121521;color:var(--ink)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #2a2e3a;padding:6px 10px;border-radius:999px;background:#121521}
    .controls{display:flex;gap:10px;justify-content:space-between;margin-top:16px}
    .controls .left,.controls .right{display:flex;gap:10px}
    button{appearance:none;border:1px solid #2a2e3a;background:#15192a;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
    .primary{background:linear-gradient(180deg,#2a66ff,#1a49c7);border-color:#3559ff}
    .success{background:linear-gradient(180deg,#41d696,#24b374);border-color:#2dc184}
    .danger{background:linear-gradient(180deg,#ff8a7a,#f14a3b);border-color:#f06858}
    .card{border:1px solid #2a2e3a;background:#121521;border-radius:14px;padding:12px}
    .kicker{font-size:.9rem;color:var(--muted)}
    .muted{color:var(--muted)}
    .callout{border:1px dashed #3a3f52;border-radius:12px;padding:10px;background:#10131d}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tag{display:inline-block;font-size:.8rem;background:#0f1320;border:1px solid #2a2e3a;padding:2px 8px;border-radius:999px;margin-right:6px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #2a2e3a;padding:8px 6px;text-align:left}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hidden{display:none}
    footer{max-width:1100px;margin:30px auto;padding:16px;color:var(--muted)}
    @media (max-width:920px){.wizard{grid-template-columns:1fr}}
    /* Print styles */
    @media print{
      header, .nav, footer, .controls .left, .controls .right button#save_s, .controls .right button#export_s { display:none !important; }
      body{ background:#fff; color:#000; }
      .panel, .card{ background:#fff !important; border:1px solid #ccc !important; color:#000; }
      .tag{ border-color:#bbb; background:#f7f7f7; }
      .wizard{ grid-template-columns:1fr !important; }
      .wrap, main, footer{ padding:0; margin:0; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Oracle Trials — Character Builder</h1>
      <div class="subtitle">D&D 5e compatible one-shot builder with University, Jobs, Extracurriculars, Exams, and Student Dice. <strong>Sessions & Signup + Print/PDF</strong>.</div>
    </div>
  </header>

  <main>
    <div class="wizard">
      <nav class="nav">
        <h3>Steps</h3>
        <div class="steps" id="stepNav"></div>
        <div class="callout" style="margin-top:12px">
          <div class="kicker">Quick actions</div>
          <div class="flex" style="margin-top:6px">
            <button id="btnSave">Save Draft</button>
            <button id="btnLoad">Load Draft</button>
            <button id="btnExport" class="primary">Export JSON</button>
            <button id="btnClear" class="danger">Clear Local Data</button>
          </div>
          <div class="muted" style="margin-top:6px">Print/PDF is on the Summary step.</div>
        </div>
      </nav>

      <section id="panels" class="grid" style="gap:16px"></section>
    </div>
  </main>

  <footer>
    <div>This is the single-file build. Everything (data, UI, logic) lives in this HTML.</div>
  </footer>

  <script>
  /* =======================
     CONSTANTS & STORES
  ======================= */
  const AVAIL_DATES = [
    '2025-12-21','2025-12-22','2025-12-23','2025-12-24','2025-12-25',
    '2025-12-26','2025-12-27','2025-12-28','2025-12-29','2026-01-01'
  ];
  const AvailabilityStore = {
    key: 'oracleAvailability',
    read(){ try{return JSON.parse(localStorage.getItem(this.key)||'{}');}catch{ return {}; } },
    write(obj){ localStorage.setItem(this.key, JSON.stringify(obj)); }
  };

  // Optional quick rules (example): block Melissa on 2025-12-28, hard "No" for Link
  const ELIGIBILITY = {
    hardNo: ["Link"],
    blockedDates: { "Melissa": ["2025-12-28"] }
  };

  /* =======================
     DATA
  ======================= */
  const DATA = {
    levels:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],
    abilityArrays:{ standard:[15,14,13,12,10,8] },
    universities:[
      { key:'lorehold', name:'Lorehold', theme:'History & Spirits', colours:'Red/White', focus:'Archaeomancy', playstyle:'Scholar / Explorer', spells:{
          1:['Comprehend Languages','Identify'],
          2:['Borrowed Knowledge','Locate Object'],
          3:['Speak with Dead','Spirit Guardians'],
          4:['Arcane Eye','Stone Shape'],
          5:['Flame Strike','Legend Lore']
      }},
      { key:'prismari', name:'Prismari', theme:'Elemental Arts', colours:'Blue/Red', focus:'Performance & Elements', playstyle:'Passion / Spectacle', spells:{
          1:['Chromatic Orb','Thunderwave'],
          2:['Flaming Sphere','Kinetic Jaunt'],
          3:['Haste','Water Walk'],
          4:['Freedom of Movement','Wall of Fire'],
          5:['Cone of Cold','Conjure Elemental']
      }},
      { key:'quandrix', name:'Quandrix', theme:'Math & Nature', colours:'Blue/Green', focus:'Fractals / Growth', playstyle:'Logical / Curious', spells:{
          1:['Entangle','Guiding Bolt'],
          2:['Enlarge/Reduce','Vortex Warp'],
          3:['Aura of Vitality','Haste'],
          4:['Control Water','Freedom of Movement'],
          5:['Circle of Power','Passwall']
      }},
      { key:'silverquill', name:'Silverquill', theme:'Eloquence & Ink', colours:'White/Black', focus:'Radiance & Shadow', playstyle:'Charisma / Wit', spells:{
          1:['Dissonant Whispers','Silvery Barbs'],
          2:['Calm Emotions','Darkness'],
          3:['Beacon of Hope','Daylight'],
          4:['Compulsion','Confusion'],
          5:['Dominate Person','Rary’s Telepathic Bond']
      }},
      { key:'witherbloom', name:'Witherbloom', theme:'Life & Decay', colours:'Green/Black', focus:'Alchemy / Essence', playstyle:'Healer / Witch', spells:{
          1:['Cure Wounds','Inflict Wounds'],
          2:['Lesser Restoration','Wither and Bloom'],
          3:['Revivify','Vampiric Touch'],
          4:['Blight','Death Ward'],
          5:['Antilife Shell','Greater Restoration']
      }}
    ],
    backgrounds:[
      {key:'lorehold-student', name:'Lorehold Student', skills:['History','Religion'], tools:[], languages:'2 of choice', gear:['Ink/pen','Hammer','Lantern','History tome','Uniform'], feat:'Strixhaven Initiate (Lorehold)'},
      {key:'prismari-student', name:'Prismari Student', skills:['Acrobatics','Performance'], tools:['+1 instrument/tool'], languages:'1', gear:['Ink/pen','Artisan tools or Instrument','Uniform'], feat:'Strixhaven Initiate (Prismari)'},
      {key:'quandrix-student', name:'Quandrix Student', skills:['Arcana','Nature'], tools:['+1 artisan tool'], languages:'1', gear:['Ink/pen','Abacus','Arcane theory book','Uniform'], feat:'Strixhaven Initiate (Quandrix)'},
      {key:'silverquill-student', name:'Silverquill Student', skills:['Intimidation','Persuasion'], tools:[], languages:'2', gear:['Ink/pen','Poetry book','Uniform'], feat:'Strixhaven Initiite (Silverquill)'},
      {key:'witherbloom-student', name:'Witherbloom Student', skills:['Nature','Survival'], tools:['Herbalism Kit'], languages:'1', gear:['Plant ID book','Iron pot','Herbalism kit','Uniform'], feat:'Strixhaven Initiate (Witherbloom)'}
    ],
    extracurriculars:[
      {key:'dead-languages', name:'Dead Languages Society', skills:['Athletics','History']},
      {key:'fine-artists', name:'Distinguished Society of Fine Artists', skills:['Performance','Sleight of Hand']},
      {key:'dragonchess', name:'Dragonchess Club', skills:['Deception','Investigation']},
      {key:'historical-soc', name:'Dragonsguard Historical Society', skills:['Arcana','History']},
      {key:'horticulture', name:'Fantastical Horticulture Club', skills:['Nature','Survival']},
      {key:'entrepreneurs', name:'Future Entrepreneurs of Strixhaven', skills:['Insight','Persuasion']},
      {key:'gymnastics', name:'Intramural Gymnastics', skills:['Acrobatics','Performance']},
      {key:'silkball', name:'Silkball Club', skills:['Athletics','Intimidation']},
      {key:'water-dance', name:'Water-Dancing Club', skills:['Athletics','Performance']},
      {key:'larp', name:'LARP Guild', skills:['Animal Handling','Performance']},
      {key:'cheer', name:'Mage Tower Cheer', skills:['Perception','Persuasion']},
      {key:'drama', name:'Playactors Drama Guild', skills:['Arcana','Deception']},
      {key:'iron-lifters', name:'Iron-Lifters', skills:['Athletics','Medicine']},
      {key:'show-band', name:'Show Band', skills:['Sleight of Hand','Performance']},
      {key:'newspaper', name:'Strixhaven Star (Newspaper)', skills:['Investigation','Insight']},
      {key:'faith', name:'Student-Mages of Faith', skills:['Insight','Religion']}
    ],
    jobs:[
      {key:'biblioplex', name:'Biblioplex', skills:['Arcana','History']},
      {key:'firejolt', name:'Firejolt Café', skills:['Insight','Persuasion']},
      {key:'bowsend', name:"Bow's End Tavern", skills:['Performance','Deception']},
      {key:'stadium', name:'Stadium', skills:['Athletics','Intimidation']},
      {key:'performing-arts', name:'Performing Arts Society', skills:['Performance','Deception']},
      {key:'dorms', name:'Dormitories', skills:['Persuasion','Perception']},
      {key:'grounds', name:'Campus Grounds', skills:['Nature','Survival']},
      {key:'labs', name:'Magic Labs', skills:['Arcana','Investigation']},
      {key:'intramural', name:'Intramural Fields', skills:['Athletics','Acrobatics']}
    ],
    roster:[
      {name:'Mike', status:'Maybe'},{name:'Megan', status:'Maybe'},{name:'Jocelyn', status:'Maybe'},{name:'Emory', status:'Maybe'},
      {name:'Snack Erin', status:'Yes', notes:'Schedule Dependant'},
      {name:'Erin', status:'Preferred', notes:'26/27'},
      {name:'Trevor', status:'Preferred', notes:'22, 27, and 28/29 of December'},
      {name:'Amy', status:'Yes'},{name:'Bela', status:'Unknown'},
      {name:'Nicole', status:'Yes', notes:'26-27'},{name:'Spencer', status:'Yes', notes:'26-27'},
      {name:'Marvin', status:'Unknown'},{name:'Megan E.', status:'Unknown'},{name:'Jordan', status:'Unknown'},
      {name:'Becca', status:'Preferred', notes:'27, 28'},
      {name:'Evan', status:'Preferred', notes:'27, 28'},
      {name:'Lyric', status:'Unknown'},
      {name:'Lazarus', status:'KidsTable', notes:'extra kids table prior to other games'},
      {name:'Aramis', status:'Unknown'},{name:'James', status:'Unknown'},{name:'David', status:'Unknown'},
      {name:'Nova', status:'Yes', notes:'Checking Schedule'},
      {name:'Link', status:'No'},
      {name:'Melissa', status:'Yes', notes:'Cannot do Dec 28'}
    ],
    sessions:[
      {id:'s1', date:'2025-12-22', title:'Oracle Heat A', dm:'Kaela', capacity:6, players:[]},
      {id:'s2', date:'2025-12-26', title:'Oracle Heat B', dm:'Tory',  capacity:6, players:[]},
      {id:'s3', date:'2025-12-27', title:'Oracle Heat C', dm:'Kaela', capacity:6, players:[]},
      {id:'s4', date:'2025-12-28', title:'Oracle Heat D', dm:'Tory',  capacity:6, players:[]},
      {id:'s5', date:'2025-12-29', title:'Oracle Heat E', dm:'Kaela', capacity:6, players:[]},
      {id:'finale', date:'2026-01-01', title:'Grand Finale', dm:'Kaela & Tory', capacity:8, players:[], finale:true}
    ],
    // Always show roster alphabetically by name (without changing your source list)
DATA.roster = [...DATA.roster].sort((a,b)=>a.name.localeCompare(b.name,'en'));

  };

  /* =======================
     VALIDATION & ERROR HANDLING
  ======================= */
  function validateConfig(){
    const errors=[];

    // AVAIL_DATES must exist and be ISO dates
    try{
      if(typeof AVAIL_DATES==='undefined' || !Array.isArray(AVAIL_DATES)) {
        errors.push('AVAIL_DATES is missing or not an array.');
      } else {
        AVAIL_DATES.forEach((d,i)=>{
          if(!/^\d{4}-\d{2}-\d{2}$/.test(String(d))) errors.push(`AVAIL_DATES[${i}] must be in YYYY-MM-DD format (got "${d}")`);
        });
      }
    }catch{ errors.push('AVAIL_DATES could not be read.'); }

    // DATA.sessions checks
    try{
      if(!DATA.sessions || !Array.isArray(DATA.sessions)) {
        errors.push('DATA.sessions is missing or not an array.');
      } else {
        const ids=new Set();
        DATA.sessions.forEach((s,idx)=>{
          if(!s || typeof s!=='object'){ errors.push(`sessions[${idx}] is not an object`); return; }
          if(!s.id){ errors.push(`sessions[${idx}] is missing an id`); }
          if(s.id){ if(ids.has(s.id)) errors.push(`Duplicate session id: ${s.id}`); else ids.add(s.id); }
          if(!/^\d{4}-\d{2}-\d{2}$/.test(String(s.date||''))) errors.push(`${s.title||s.id||('session#'+idx)} has a non-ISO date "${s.date}"`);
          if(typeof s.capacity !== 'number') errors.push(`${s.title||s.id||('session#'+idx)} capacity must be a number`);
        });
      }
    }catch{ errors.push('DATA.sessions could not be validated.'); }

    // DATA.roster checks
    try{
      if(!Array.isArray(DATA.roster)) {
        errors.push('DATA.roster is missing or not an array.');
      } else {
        DATA.roster.forEach((r,i)=>{ if(!r || !r.name) errors.push(`roster[${i}] is missing a name`); });
      }
    }catch{ errors.push('DATA.roster could not be validated.'); }

    return errors;
  }

  function showErrors(errors){
    if(!errors || !errors.length) return;
    const main=document.querySelector('main');
    const box=document.createElement('div');
    box.className='panel';
    box.style.border='1px solid #f14a3b';
    box.style.background='#1d1111';
    box.style.color='var(--ink)';
    box.innerHTML = `
      <h2>Configuration issues</h2>
      <p>Something in the editable data is off. Fix the items below, then refresh. If you changed dates/IDs recently, hit <strong>Clear Local Data</strong> in the sidebar.</p>
      <ul>${errors.map(e=>`<li>${e.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</li>`).join('')}</ul>
    `;
    main.prepend(box);
  }

  window.addEventListener('error', (e)=>{
    const main=document.querySelector('main');
    if(!main) return;
    const box=document.createElement('div');
    box.className='panel';
    box.style.border='1px solid #f14a3b';
    box.style.background='#1d1111';
    box.innerHTML=`<strong>Runtime error:</strong> ${String(e.message||'Unknown error')}`;
    main.prepend(box);
  });

  /* =======================
     STATE
  ======================= */
  const State = {
    data:{
      meta:{version:'0.4-scheduler-fixed'},
      core:{ name:'', race:'', class:'', background:'', level:3, abilityMethod:'standard', abilities:{STR:15,DEX:14,CON:13,INT:12,WIS:10,CHA:8}, equipment:'class'},
      university:{ key:'', spellAbility:'INT' },
      feats:[],
      extras:{ job:null, clubs:[], studentDice:[] },
      personality:{ traits:'', ideal:'', bond:'', rival:'', goal:'', prompt:'' },
      exams:{ notes:'', studyRerolls:0, results:[] }
    },
    sessions: JSON.parse(localStorage.getItem('oracleSessions')||'null') || DATA.sessions.map(x=>({...x})),
    save(){ localStorage.setItem('oracleTrialsSave', JSON.stringify(this.data)); alert('Draft saved to your browser.'); },
    load(){ const raw=localStorage.getItem('oracleTrialsSave'); if(!raw){alert('No save found.');return;} this.data=JSON.parse(raw); (function(){
    const errs = validateConfig();
    if(errs.length){
      showErrors(errs);
      bindHeaderActions();
      return;
    }
    renderAll();
  })(); alert('Draft loaded.'); },
    export(){ const blob=new Blob([JSON.stringify({character:this.data, sessions:this.sessions},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`oracle-trials-${(this.data.core.name||'character').toLowerCase().replace(/[^a-z0-9\-]/g,'-')}.json`; a.click(); URL.revokeObjectURL(url); },
    saveSessions(){ localStorage.setItem('oracleSessions', JSON.stringify(this.sessions)); }
  };

  /* =======================
     HELPERS
  ======================= */
  function getCurrentCharacterName(){
    const fromState = (State.data?.core?.name||'').trim();
    if(fromState) return fromState;
    const input = document.querySelector('#core_name');
    return (input?.value||'').trim();
  }

  function downloadICS(session){
    // Default 7–9pm local (America/Edmonton). Adjust if needed.
    const tz = 'America/Edmonton';
    const start = new Date(`${session.date}T19:00:00`);
    const end   = new Date(start.getTime() + 2*60*60*1000);

    const toLocalICS = (d)=> {
      const yyyy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const dd=String(d.getDate()).padStart(2,'0');
      const HH=String(d.getHours()).padStart(2,'0');
      const MM=String(d.getMinutes()).padStart(2,'0');
      const SS='00';
      return `${yyyy}${mm}${dd}T${HH}${MM}${SS}`;
    };

    const uid = `${session.id}@oracletrials`;
    const ics = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//OracleTrials//Scheduler//EN',
      'CALSCALE:GREGORIAN',
      'METHOD:PUBLISH',
      'BEGIN:VEVENT',
      `UID:${uid}`,
      `SUMMARY:${session.title}`,
      `DESCRIPTION:DM: ${session.dm} | Capacity: ${session.capacity}`,
      `DTSTART;TZID=${tz}:${toLocalICS(start)}`,
      `DTEND;TZID=${tz}:${toLocalICS(end)}`,
      'END:VEVENT',
      'END:VCALENDAR'
    ].join('\r\n');

    const blob = new Blob([ics], {type:'text/calendar'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${session.title.replace(/\s+/g,'-')}.ics`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function downloadSessionsCSV() {
    const avail = AvailabilityStore.read();
    const builds = JSON.parse(localStorage.getItem('oracleBuildCards')||'{}');

    const header1 = ["id","date","title","dm","capacity","players"];
    const header2 = ["name","class","university","signed_sessions","available_dates"];

    const rows = [];
    rows.push(header1);
    State.sessions.forEach(s=>{
      rows.push([s.id, s.date, s.title, s.dm, s.capacity, (s.players||[]).join(" | ")]);
    });

    rows.push([]); // blank line
    rows.push(header2);
    DATA.roster.forEach(r=>{
      const b = builds[r.name]||{};
      const signed = State.sessions.filter(s=>(s.players||[]).includes(r.name)).map(s=>`${s.title} (${s.date})`).join(' | ');
      const a = Object.entries(avail[r.name]||{}).filter(([_,v])=>v).map(([d])=>d.slice(5)).join(' ');
      rows.push([r.name, b.class||'', b.university||'', signed, a]);
    });

    const csv = rows.map(r=>r.map(x=>`"${String(x??'').replaceAll('"','""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "oracle-sessions-and-availability.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  /* store tiny public build cards by name so session lists can show Class • University */
  function saveBuildCard(){
    const name = getCurrentCharacterName();
    if(!name) return;
    const uniKey = State.data?.university?.key || '';
    const uniName = (DATA.universities.find(u=>u.key===uniKey)?.name) || '';
    const klass = State.data?.core?.class || '';
    const cards = JSON.parse(localStorage.getItem('oracleBuildCards')||'{}');
    cards[name] = { class: klass, university: uniName };
    localStorage.setItem('oracleBuildCards', JSON.stringify(cards));
  }

  /* =======================
     STEPS
  ======================= */
  const STEPS = [
    {key:'intro',      label:'1) Welcome'},
    {key:'sessions',   label:'2) Sessions & Signup'},
    {key:'core',       label:'3) Core 5e Setup'},
    {key:'university', label:'4) University & Feat'},
    {key:'extras',     label:'5) Job & Extracurriculars'},
    {key:'personality',label:'6) Personality & Prompt'},
    {key:'summary',    label:'7) Summary & Export'}
  ];
  let currentStep = 0;

  function renderNav(){
    const nav = document.getElementById('stepNav');
    nav.innerHTML = '';
    STEPS.forEach((s,idx)=>{
      const b=document.createElement('button');
      b.className='stepbtn'+(idx===currentStep?' active':'');
      b.textContent=s.label;
      b.onclick=()=>{currentStep=idx; renderPanels();};
      nav.appendChild(b);
    });
  }

  function renderPanels(){
    const el = document.getElementById('panels');
    el.innerHTML='';
    const step = STEPS[currentStep].key;
    if(step==='intro') el.appendChild(panelIntro());
    if(step==='sessions') el.appendChild(panelSessions());
    if(step==='core') el.appendChild(panelCore());
    if(step==='university') el.appendChild(panelUniversity());
    if(step==='extras') el.appendChild(panelExtras());
    if(step==='personality') el.appendChild(panelPersonality());
    if(step==='summary') el.appendChild(panelSummary());
  }

  /* =======================
     PANELS
  ======================= */
  function panelIntro(){
    const p=document.createElement('div'); p.className='panel';
    p.innerHTML = `
      <h2>Oracle Trials — Winter One-Shot Tournament</h2>
      <div class="card">
        <p>Welcome to the Oracle Trials! Players from different academies compete in a series of festive one-shots leading to a New Year’s Day finale. Expect cozy vibes, clever play, and a little friendly rivalry.</p>
        <ul>
          <li><strong>When:</strong> Dec 21–29, Finale Jan 1</li>
          <li><strong>What to bring:</strong> dice, pencil, character idea, snack to share (potluck encouraged!)</li>
          <li><strong>Level:</strong> DM will confirm (likely 3)</li>
        </ul>
        <p class="muted">Tip: Go to “Sessions & Signup” first to mark availability and claim a seat. Then finish your character.</p>
      </div>
      <div class="controls"><div></div><div><button class="primary" id="next_intro">Go to Sessions →</button></div></div>
    `;
    p.querySelector('#next_intro').onclick = ()=>{ currentStep = STEPS.findIndex(s=>s.key==='sessions'); renderAll(); };
    return p;
  }

  function panelSessions(){
    const p=document.createElement('div'); p.className='panel';
    p.innerHTML = `
      <h2>Sessions & Signup</h2>
      <div class="grid cols-2">
        <div>
          <div class="kicker">Schedule</div>
          <div id="session_list" class="grid"></div>
        </div>
        <div>
          <div class="kicker">Player Roster & Availability</div>
          <div class="card" style="overflow:auto">
            <table class="table" id="avail_table">
              <thead>
                <tr>
                  <th>Name</th>
                  ${AVAIL_DATES.map(d=>`<th title="${d}">${d.slice(5)}</th>`).join('')}
                </tr>
              </thead>
              <tbody id="roster_tbody"></tbody>
            </table>
            <div class="muted" style="margin-top:6px">Tick when someone is available. Saves automatically.</div>
          </div>
        </div>
      </div>
      <div class="controls">
        <div class="left"><button id="back_sessions">← Back</button></div>
        <div class="right">
          <button id="csv_export">Export CSV</button>
          <button id="next_sessions" class="primary">Next →</button>
        </div>
      </div>
    `;

    /* --- Availability grid --- */
    const avail = AvailabilityStore.read();
    const rbody = p.querySelector('#roster_tbody');
    rbody.innerHTML = DATA.roster.map(r=>{
      const row = [`<td>${r.name}</td>`]
      AVAIL_DATES.forEach(d=>{
        const checked = (avail[r.name]?.[d]) ? 'checked' : '';
        row.push(`<td style="text-align:center"><input data-name="${r.name}" data-date="${d}" type="checkbox" ${checked}></td>`);
      });
      return `<tr>${row.join('')}</tr>`;
    }).join('');

    rbody.addEventListener('change', (e)=>{
      const cb = e.target.closest('input[type="checkbox"][data-name]');
      if(!cb) return;
      const name = cb.getAttribute('data-name');
      const date = cb.getAttribute('data-date');
      avail[name] = avail[name] || {};
      avail[name][date] = cb.checked;
      AvailabilityStore.write(avail);
    });

    /* --- Sessions list (read-only dates) --- */
    const wrap=p.querySelector('#session_list');
    function drawSessions(){
      const SignedUpBuilds = JSON.parse(localStorage.getItem('oracleBuildCards')||'{}');
      wrap.innerHTML='';
      State.sessions.sort((a,b)=>a.date.localeCompare(b.date)).forEach(s=>{
        const filled = (s.players||[]).length;
        const full = filled>=s.capacity;
        const rosterChips = (s.players||[]).length
          ? s.players.map(name=>{
              const build = SignedUpBuilds[name];
              const extra = build ? ` — <span class="muted">${build.class||'?'} • ${build.university||'?'}</span>` : '';
              return `<div class="pill"><span>${name}</span>${extra}</div>`;
            }).join('')
          : '<span class="muted">No players yet</span>';

        const hintUni = `<div class="muted" style="margin-top:4px">No duplicate universities allowed. Pick a unique college.</div>`;

        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <div class="flex" style="justify-content:space-between">
            <div>
              <strong>${s.title}</strong>
              <div class="muted">${s.date} • DM: ${s.dm} • Capacity: ${filled}/${s.capacity}</div>
              ${hintUni}
            </div>
            <div class="flex">
              <button data-id="${s.id}" class="primary"${full?' disabled':''}>Add my character</button>
              <button data-ics="${s.id}">.ics</button>
            </div>
          </div>
          <div style="margin-top:8px" class="flex">${rosterChips}</div>
        `;
        wrap.appendChild(card);
      });
    }

    function canJoinSession(session){
      // Enforce unique university per session
      const uniName = (DATA.universities.find(u=>u.key===State.data?.university?.key)?.name) || '';
      if(!uniName) return {ok:false, msg:'Pick a University (step 4) first.'};
      for(const n of (session.players||[])){
        const b = JSON.parse(localStorage.getItem('oracleBuildCards')||'{}')[n];
        if(b && b.university === uniName){
          return {ok:false, msg:`Another ${uniName} student is already in this session.`};
        }
      }
      return {ok:true};
    }

    wrap.addEventListener('click', (ev)=>{
      const addBtn = ev.target.closest('button.primary[data-id]');
      if(addBtn){
        const id = addBtn.getAttribute('data-id');
        const s = State.sessions.find(x=>x.id===id);
        const name = getCurrentCharacterName();
        if(!name){ alert('Give your character a name (Step 3) before joining.'); return; }
        s.players = s.players||[];
        if(s.players.includes(name)){ alert('This character is already in that session.'); return; }
        if(s.players.length>=s.capacity){ alert('That session is full.'); return; }
        saveBuildCard();
        const ok = canJoinSession(s);
        if(!ok.ok){ alert(ok.msg); return; }
        s.players.push(name);
        State.saveSessions();
        drawSessions();
        alert(`Added ${name} to ${s.title}.`);
        return;
      }
      const icsBtn = ev.target.closest('button[data-ics]');
      if(icsBtn){
        const id = icsBtn.getAttribute('data-ics');
        const s = State.sessions.find(x=>x.id===id);
        downloadICS(s);
        return;
      }
    });

    drawSessions();
    p.querySelector('#csv_export').onclick = downloadSessionsCSV;
    p.querySelector('#back_sessions').onclick=()=>{ currentStep = STEPS.findIndex(s=>s.key==='intro'); renderAll(); };
    p.querySelector('#next_sessions').onclick=()=>{ currentStep = STEPS.findIndex(s=>s.key==='core'); renderAll(); };
    return p;
  }

  function panelCore(){
    const p = document.createElement('div'); p.className='panel';
    p.innerHTML = `
      <h2>Core 5e Setup</h2>
      <div class="grid cols-2">
        <div><label>Name</label><input id="core_name" placeholder="e.g., Aria Winterborn" /></div>
        <div><label>Level</label><select id="core_level"></select></div>
        <div><label>Race</label><input id="core_race" placeholder="Any 5e race" /></div>
        <div><label>Class</label><input id="core_class" placeholder="Any 5e class" /></div>
        <div><label>Background</label><input id="core_background" placeholder="PHB/Custom" /></div>
        <div>
          <label>Ability Scores</label>
          <div class="row">
            <select id="ability_method">
              <option value="standard">Standard Array (15,14,13,12,10,8)</option>
              <option value="manual">Manual Entry</option>
            </select>
            <select id="equipment">
              <option value="class">Class Starting Equipment</option>
              <option value="50gp">50 gp</option>
            </select>
          </div>
        </div>
      </div>
      <div id="ability_box" class="two" style="margin-top:10px"></div>
      <div class="controls">
        <div class="left"></div>
        <div class="right"><button class="primary" id="next_core">Next →</button></div>
      </div>
    `;

    const levelSel = p.querySelector('#core_level');
    DATA.levels.forEach(l=>{ const o=document.createElement('option'); o.value=l; o.textContent=l; levelSel.appendChild(o); });

    const box = p.querySelector('#ability_box');
    function drawAbilityInputs(){
      box.innerHTML='';
      const m = p.querySelector('#ability_method').value;
      const abilities = ['STR','DEX','CON','INT','WIS','CHA'];
      if(m==='standard'){
        const arr = DATA.abilityArrays.standard.slice();
        abilities.forEach((ab)=>{
          const d=document.createElement('div'); d.className='card';
          d.innerHTML=`<label>${ab}</label><select data-ab="${ab}">${arr.map(v=>`<option value="${v}">${v}</option>`).join('')}</select>`;
          box.appendChild(d);
        });
      } else {
        abilities.forEach(ab=>{
          const d=document.createElement('div'); d.className='card';
          d.innerHTML=`<label>${ab}</label><input type="number" min="3" max="18" value="10" data-ab="${ab}" />`;
          box.appendChild(d);
        });
      }
    }
    p.querySelector('#ability_method').addEventListener('change', drawAbilityInputs);
    drawAbilityInputs();

    const s = State.data.core;
    p.querySelector('#core_name').value = s.name;
    p.querySelector('#core_race').value = s.race;
    p.querySelector('#core_class').value = s.class;
    p.querySelector('#core_background').value = s.background;
    p.querySelector('#core_level').value = s.level;
    p.querySelector('#ability_method').value = s.abilityMethod;
    p.querySelector('#equipment').value = s.equipment;
    drawAbilityInputs();

    // keep name in state live to avoid "no name" bug elsewhere
    p.querySelector('#core_name').addEventListener('input', (e)=>{
      State.data.core.name = e.target.value.trim();
    });

    p.querySelector('#next_core').onclick = ()=>{
      const abilities = ['STR','DEX','CON','INT','WIS','CHA'];
      const abObj = {};
      abilities.forEach(ab=>{
        const el = box.querySelector(`[data-ab="${ab}"]`);
        abObj[ab] = parseInt(el.value,10);
      });
      State.data.core = {
        name: p.querySelector('#core_name').value.trim(),
        race: p.querySelector('#core_race').value.trim(),
        class: p.querySelector('#core_class').value.trim(),
        background: p.querySelector('#core_background').value.trim(),
        level: parseInt(p.querySelector('#core_level').value,10),
        abilityMethod: p.querySelector('#ability_method').value,
        abilities: abObj,
        equipment: p.querySelector('#equipment').value
      };
      currentStep = STEPS.findIndex(s=>s.key==='university');
      renderAll();
    };
    return p;
  }

  function panelUniversity(){
    const p=document.createElement('div'); p.className='panel';
    p.innerHTML=`
      <h2>University & Feat</h2>
      <div class="grid cols-2">
        <div>
          <label>Choose University</label>
          <select id="uni"></select>
        </div>
        <div>
          <label>Strixhaven Initiate — Spellcasting Ability</label>
          <select id="spell_ability"><option>INT</option><option>WIS</option><option>CHA</option></select>
        </div>
      </div>
      <div id="uni_info" class="card" style="margin-top:10px"></div>
      <div class="controls">
        <div class="left"><button id="back_u">← Back</button></div>
        <div class="right"><button class="primary" id="next_u">Next →</button></div>
      </div>
    `;
    const sel=p.querySelector('#uni');
    sel.innerHTML = `<option value="">— Select —</option>`+DATA.universities.map(u=>`<option value="${u.key}">${u.name}</option>`).join('');
    function drawInfo(){
      const key = sel.value; const out=p.querySelector('#uni_info');
      if(!key){ out.innerHTML='<span class="muted">Select a university to view theme & bonus spells.</span>'; return; }
      const u = DATA.universities.find(x=>x.key===key);
      const spellRows = Object.entries(u.spells).map(([lvl,list])=>`<tr><td>${lvl}</td><td>${list.join(', ')}</td></tr>`).join('');
      out.innerHTML = `
        <div class="two">
          <div>
            <div class="kicker">Theme</div><div>${u.theme}</div>
            <div class="kicker" style="margin-top:6px">Focus</div><div>${u.focus}</div>
            <div class="kicker" style="margin-top:6px">Colours</div><div>${u.colours}</div>
            <div class="kicker" style="margin-top:6px">Playstyle</div><div>${u.playstyle}</div>
          </div>
          <div>
            <div class="kicker">Bonus Spells</div>
            <table class="table"><thead><tr><th>Level</th><th>Spells</th></tr></thead><tbody>${spellRows}</tbody></table>
          </div>
        </div>
        <div class="callout" style="margin-top:8px"><strong>Feat:</strong> Strixhaven Initiate — Choose college, 2 cantrips + one 1st-level spell (cast 1/day free; choose Int/Wis/Cha).</div>
      `;
    }
    sel.addEventListener('change', drawInfo);
    sel.value = State.data.university.key || '';
    p.querySelector('#spell_ability').value = State.data.university.spellAbility || 'INT';
    drawInfo();
    p.querySelector('#back_u').onclick=()=>{currentStep = STEPS.findIndex(s=>s.key==='core'); renderAll();};
    p.querySelector('#next_u').onclick=()=>{
      State.data.university={ key: sel.value, spellAbility: p.querySelector('#spell_ability').value };
      if(!State.data.university.key){ alert('Pick a university to continue.'); return; }
      if(!State.data.feats.find(f=>f.name==='Strixhaven Initiate')){
        State.data.feats.push({name:'Strixhaven Initiate', ability: State.data.university.spellAbility });
      } else {
        State.data.feats = State.data.feats.map(f=> f.name==='Strixhaven Initiate'? {...f, ability: State.data.university.spellAbility }: f);
      }
      currentStep = STEPS.findIndex(s=>s.key==='extras'); renderAll();
    };
    return p;
  }

  function panelExtras(){
    const p=document.createElement('div'); p.className='panel';
    p.innerHTML=`
      <h2>Job & Extracurriculars</h2>
      <div class="grid cols-2">
        <div>
          <label>Job (optional, 5 gp/week)</label>
          <select id="job"><option value="">— None —</option>${DATA.jobs.map(j=>`<option value="${j.key}">${j.name}</option>`).join('')}</select>
        </div>
        <div>
          <label>Extracurriculars (pick up to 2; 1 if you also take a job)</label>
          <div id="clublist" class="grid cols-2" style="max-height:240px;overflow:auto"></div>
        </div>
      </div>
      <div id="bonus_readout" class="callout" style="margin-top:10px"></div>
      <div class="controls">
        <div class="left"><button id="back_e">← Back</button></div>
        <div class="right"><button class="primary" id="next_e">Next →</button></div>
      </div>
    `;
    const clubWrap = p.querySelector('#clublist');
    function drawClubs(){
      clubWrap.innerHTML='';
      DATA.extracurriculars.forEach(c=>{
        const id=`club_${c.key}`;
        const d=document.createElement('label'); d.className='card'; d.style.cursor='pointer';
        d.innerHTML=`<div class="flex"><input type="checkbox" id="${id}" data-key="${c.key}" /> <div><strong>${c.name}</strong><div class="muted">Student Die (d4): ${c.skills.join(' / ')}</div></div></div>`;
        clubWrap.appendChild(d);
      });
    }
    drawClubs();

    const jobSel = p.querySelector('#job');
    jobSel.value = State.data.extras.job || '';
    (State.data.extras.clubs||[]).forEach(k=>{ const el = clubWrap.querySelector(`[data-key="${k}"]`); if(el) el.checked=true; });

    function readExtras(){
      const jobKey = jobSel.value || null;
      const pickedClubs = [...clubWrap.querySelectorAll('input[type="checkbox"]:checked')].map(x=>x.dataset.key);
      const maxClubs = jobKey?1:2;
      if(pickedClubs.length>maxClubs){
        const last = pickedClubs.pop();
        clubWrap.querySelector(`[data-key="${last}"]`).checked=false;
      }
      const job = DATA.jobs.find(j=>j.key===jobKey);
      const clubs = DATA.extracurriculars.filter(c=>pickedClubs.includes(c.key));
      const parts=[];
      if(job) parts.push(`<span class="tag">Job: ${job.name} — d4: ${job.skills.join(' / ')}</span>`);
      clubs.forEach(c=>parts.push(`<span class="tag">Club: ${c.name} — d4: ${c.skills.join(' / ')}</span>`));
      p.querySelector('#bonus_readout').innerHTML = parts.length? parts.join(' '): '<span class="muted">Pick a job and/or clubs to see Student Dice bonuses.</span>';
      return { job: jobKey, clubs: pickedClubs };
    }

    jobSel.addEventListener('change', readExtras);
    clubWrap.addEventListener('change', readExtras);
    readExtras();

    p.querySelector('#back_e').onclick=()=>{currentStep = STEPS.findIndex(s=>s.key==='university'); renderAll();};
    p.querySelector('#next_e').onclick=()=>{
      const {job, clubs} = readExtras();
      State.data.extras.job = job;
      State.data.extras.clubs = clubs;
      currentStep = STEPS.findIndex(s=>s.key==='personality'); renderAll();
    };
    return p;
  }

  function panelPersonality(){
    const p=document.createElement('div'); p.className='panel';
    p.innerHTML=`
      <h2>Personality & Prompt</h2>
      <div class="grid cols-2">
        <div><label>Traits (1–2)</label><textarea id="traits" rows="3" placeholder="e.g., Curious, dry humour"></textarea></div>
        <div><label>Ideal</label><textarea id="ideal" rows="3" placeholder="e.g., Knowledge must be shared."></textarea></div>
        <div><label>Bond / Friend / Rival</label><textarea id="bond" rows="3" placeholder="Name someone you’re tied to (or opposed to)"></textarea></div>
        <div><label>Goal</label><textarea id="goal" rows="3" placeholder="What do you want from the Oracle Trials?"></textarea></div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="kicker">Quick-Start Character Prompt</div>
        <div id="prompt_box" class="flex" style="margin-top:6px"></div>
      </div>
      <div class="controls">
        <div class="left"><button id="back_p">← Back</button></div>
        <div class="right"><button class="primary" id="next_p">Next →</button></div>
      </div>
    `;
    const quickPrompts = [
      {u:'Lorehold', text:'A cheerful necro-historian who argues with ghosts about footnotes.'},
      {u:'Prismari', text:'A kinetic dancer who keeps leaving frost footprints after cantrips.'},
      {u:'Quandrix', text:'A fractal botanist who names houseplants after famous equations.'},
      {u:'Silverquill', text:'A sunny orator who spotlights corruption with literal light.'},
      {u:'Witherbloom', text:'A swamp witch medic who collects bones “for research.”'}
    ];
    const box=p.querySelector('#prompt_box');
    quickPrompts.forEach(q=>{
      const b=document.createElement('button'); b.className='pill'; b.type='button';
      b.innerHTML = `<span>${q.u}</span><span>•</span><span>${q.text}</span>`;
      b.onclick=()=>{ State.data.personality.prompt = q.text; Array.from(box.children).forEach(x=>x.classList.remove('success')); b.classList.add('success'); };
      box.appendChild(b);
      if(State.data.personality.prompt===q.text) b.classList.add('success');
    });

    p.querySelector('#traits').value = State.data.personality.traits||'';
    p.querySelector('#ideal').value = State.data.personality.ideal||'';
    p.querySelector('#bond').value = State.data.personality.bond||'';
    p.querySelector('#goal').value = State.data.personality.goal||'';

    p.querySelector('#back_p').onclick=()=>{currentStep = STEPS.findIndex(s=>s.key==='extras'); renderAll();};
    p.querySelector('#next_p').onclick=()=>{
      State.data.personality={
        traits: p.querySelector('#traits').value.trim(),
        ideal: p.querySelector('#ideal').value.trim(),
        bond: p.querySelector('#bond').value.trim(),
        goal: p.querySelector('#goal').value.trim(),
        prompt: State.data.personality.prompt||''
      };
      currentStep = STEPS.findIndex(s=>s.key==='summary'); renderAll();
    };
    return p;
  }

  function panelSummary(){
    const p=document.createElement('div'); p.className='panel';
    const s=State.data;
    const uni = DATA.universities.find(u=>u.key===s.university.key);
    const abilityList = Object.entries(s.core.abilities||{}).map(([k,v])=>`<span class="tag">${k}: ${v}</span>`).join(' ');
    const clubs = (s.extras.clubs||[]).map(k=> DATA.extracurriculars.find(c=>c.key===k)?.name).filter(Boolean);
    const jobName = DATA.jobs.find(j=>j.key===s.extras.job)?.name || '—';

    p.innerHTML = `
      <h2>Summary</h2>
      <div class="grid cols-2">
        <div class="card">
          <div class="kicker">Character</div>
          <div><strong>${s.core.name||'Unnamed'}</strong></div>
          <div class="muted">${s.core.race||'Race?'} • ${s.core.class||'Class?'} • Level ${s.core.level||3}</div>
          <div style="margin-top:8px">${abilityList}</div>
          <div style="margin-top:8px" class="muted">Background: ${s.core.background||'—'} • Equipment: ${s.core.equipment==='50gp'?'50 gp':'Class kit'}</div>
        </div>
        <div class="card">
          <div class="kicker">University & Feat</div>
          <div><strong>${uni?uni.name:'—'}</strong> <span class="muted">(${uni?uni.colours:'—'})</span></div>
          <div class="muted">Spellcasting Ability for Initiate: ${s.university.spellAbility||'INT'}</div>
        </div>
        <div class="card">
          <div class="kicker">Job & Clubs</div>
          <div>Job: <strong>${jobName}</strong></div>
          <div>Clubs: ${clubs.length? clubs.join(', '): '—'}</div>
        </div>
        <div class="card">
          <div class="kicker">Personality</div>
          <div>${s.personality.traits||''}</div>
          <div class="muted">Ideal: ${s.personality.ideal||''}</div>
          <div class="muted">Bond/Rival/Friend: ${s.personality.bond||''}</div>
          <div class="muted">Goal: ${s.personality.goal||''}</div>
          <div class="muted" style="margin-top:6px">Prompt: ${s.personality.prompt||'—'}</div>
        </div>
      </div>
      <div class="controls">
        <div class="left"><button id="back_s">← Back</button></div>
        <div class="right">
          <button id="save_s">Save Draft</button>
          <button id="export_s" class="primary">Export JSON</button>
          <button id="pdf_s" class="success">Print / PDF</button>
        </div>
      </div>
    `;
    p.querySelector('#back_s').onclick=()=>{currentStep = STEPS.findIndex(s=>s.key==='personality'); renderAll();};
    p.querySelector('#save_s').onclick=()=>State.save();
    p.querySelector('#export_s').onclick=()=>State.export();
    p.querySelector('#pdf_s').onclick=()=>window.print();
    return p;
  }

  /* =======================
     BOOT
  ======================= */
  function renderAll(){
    try{
      renderNav();
      renderPanels();
      bindHeaderActions();
    } catch(err){
      showErrors([`Render failed: ${String(err && err.message || err)}`]);
      console.error(err);
    }
  }
  function bindHeaderActions(){
    document.getElementById('btnSave').onclick=()=>State.save();
    document.getElementById('btnLoad').onclick=()=>State.load();
    document.getElementById('btnExport').onclick=()=>State.export();
    const clr = document.getElementById('btnClear');
    if(clr){
      clr.onclick = ()=>{
        if(confirm('Clear all local data for this app?')){
          localStorage.removeItem('oracleSessions');
          localStorage.removeItem('oracleAvailability');
          localStorage.removeItem('oracleBuildCards');
          localStorage.removeItem('oracleTrialsSave');
          alert('Local data cleared. Reloading…');
          location.reload();
        }
      };
    }
  }
  renderAll();
  </script>
</body>
</html>
